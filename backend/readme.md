# Mood Diary AI 백엔드

무드 다이어리(Mood Diary) 애플리케이션을 위한 Flask 기반 백엔드로, 고급 감정 분석 및 공감형 AI 코멘트 생성 기능을 특징으로 합니다.

## 🚀 주요 기능

### 1. 감정 분석 (LSTM)

- **모델**: 128 유닛을 가진 양방향 LSTM (Bidirectional LSTM).
- **클래스**: 5가지 감정 (행복해, 평온해, 그저그래, 우울해, 화가나).
- **훈련 데이터**: 약 47,000개의 결합된 데이터셋.
  - `GoEmotions-Korean`: 50,000개 이상의 라벨링된 문장 (Google).
  - `감성대화말뭉치`: 36,000개 이상의 대화 쌍 (AI Hub).
  - `User Data`: 10,000개 이상의 실제 일기 데이터 (파인 튜닝).
- **성능**: 저장된 모델(`emotion_model.h5`)을 통해 높은 정확도 제공.

### 2. 생성형 AI 코멘트 (고급 하이브리드 시스템)

- **시스템**: 3단계 우선순위 아키텍처.
  1.  **안전장치 (규칙 기반)**: "시험", "이별"과 같은 중요 키워드에 대해 즉각적이고 높은 품질의 조언 제공.
  2.  **KoGPT-2 (LLM)**: SKT의 `kogpt2-base-v2` 모델을 사용하여 창의적이고 시적인 답변 생성.
  3.  **Seq2Seq (대체 모델)**: 경량 백업 모델.
- **기능**: 사용자 일기를 바탕으로 공감하고 맥락을 파악하여 조언 생성.
- **최적화**: 효율적인 한국어 토큰화를 위해 `PreTrainedTokenizerFast` 사용.
- **파일**: `comment_bank.json` (규칙), `comment_model.h5` (레거시).

### 3. 능동형 학습 및 키워드 추출

- **키워드 추출**: 사용자 일기에서 감정별 키워드를 자동으로 학습.
- **지식 베이스**: `EmotionKeyword` 테이블에 현재 **30,000개 이상의 학습된 키워드** 보유.
- **지속적 학습**: 일기 데이터가 쌓일수록 시스템의 성능이 향상됨.

---

## 🛠 설정 및 실행

### A. 환경 설정

```bash
cd backend
source venv/bin/activate
```

### B. 서버 실행

```bash
python app.py
```

- 서버는 `http://127.0.0.1:5000`에서 시작됩니다.
- API 문서: `app.py`의 `/api/` 엔드포인트를 참조하세요.

### C. 스크립트를 통한 AI 관리

- **전체 모델 재훈련**: `python retrain_model.py` (강제 재훈련)
- **기존 데이터 일괄 업데이트**: `python batch_update_ai.py` (기존 일기에 새로운 AI 분석 적용)
- **코멘트 검증**: `python verify_comments.py`

## 📁 프로젝트 구조

- `ai_analysis.py`: 핵심 AI 로직 (훈련, 추론, 지속성 관리).
- `app.py`: Flask REST API 라우트.
- `models.py`: SQLAlchemy 데이터베이스 모델 (`User`, `Diary`, `EmotionKeyword`).
- `*.h5 / *.pickle`: 최적화된 AI 모델 파일.

## 🔄 최근 업데이트 (2026.01.15)

### 1. AI 모델 업그레이드 (Polyglot-Ko 1.3B)

- 기존 **KoGPT-2** (1.2억 파라미터)에서 **Polyglot-Ko 1.3B** (13억 파라미터)로 교체했습니다.
- **향상된 점**: 문맥 이해력 대폭 증가, 더 자연스럽고 풍부한 한국어 표현 가능.

### 2. 프롬프트 엔지니어링 강화 (Persona 적용)

- AI에게 **"다정하고 공감 능력이 뛰어난 심리 상담사"** 페르소나를 부여했습니다.
- 단순한 응답을 넘어, 사용자의 일기 내용에 깊이 공감하고 위로하는 2~3문장의 답변을 생성하도록 최적화되었습니다.

### 3. 클라우드 배포 최적화 (Oracle Cloud)

- **메모리 최적화**: 대형 언어 모델(LLM) 구동을 위한 메모리 관리 로직 적용.
- **안전성**: `SKIP_TRAINING=true` 환경에서도 필수 AI 데이터(감정 은행 등)는 로딩되도록 수정.
- **타임아웃 설정**: LLM 추론 시간을 고려하여 Gunicorn 타임아웃을 **120초**로 확장.

### 4. Gemini API 및 프라이버시 강화 (2026.01.17 ~ 2026.01.18)

- **Gemini 1.5 Flash 도입**: 더 빠르고 통찰력 있는 마음가짐 조언 및 코멘트 생성.
- **프라이버시 실드(Privacy Shield)**: 사용자 일기의 민감 정보 보호를 위한 데이터 비식별화 로직 적용.
  - 이메일, 전화번호 등 개인정보 자동 마스킹.
  - 외부 API 전송 전 텍스트 정제 및 길이 제한을 통해 최소한의 맥락만 공유.
- **날씨 연동 조언**: 오늘의 날씨와 사용자의 최근 감정 상태를 결합한 개인화된 조언 생성.
- **동적 모델 최적화**: API 키 권한에 따른 최적 모델 자동 탐색 및 연결 로직 적용.
- **설정**: `.env` 파일에 `GEMINI_API_KEY` 설정 필수.
