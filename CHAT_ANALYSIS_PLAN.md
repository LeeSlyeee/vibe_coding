# 🧠 채팅 기반 실시간 심리 분석 시스템 구축 계획 (Chat Analysis System)

## 1. 개요 (Overview)

현재 **마음-온(Maum-On)** iOS 앱의 채팅 기능은 사용자의 말에 공감해주는 '반응형 챗봇' 수준입니다. 이를 전문 심리 상담 수준으로 고도화하기 위해, **대화 내용에서 실시간으로 심리 상태를 분석하고 데이터를 축적하는 시스템**을 구축합니다.

이 시스템은 사용자가 채팅을 하는 동안 보이지 않는 곳에서 끊임없이 **감정, 스트레스 수준, 위험 징후**를 분석하여 **'마음 데이터'**로 변환합니다.

---

## 2. 사용자 경험 (User Experience)

1.  **자연스러운 대화**: 사용자는 기존과 동일하게 AI와 편안하게 대화를 나눕니다. 분석을 위해 별도의 설문을 하거나 멈추지 않습니다.
2.  **실시간 분석 (Backend)**: 사용자가 메시지를 보내면, 서버는 즉시 답장을 보냄과 동시에 **백그라운드에서 정밀 심리 분석**을 수행합니다.
3.  **인사이트 제공**:
    - 채팅이 종료되거나 일정 데이터가 쌓이면 **"오늘의 대화 분석 요약"**을 제공합니다. (예: "오늘 대화에서는 '불안함'이 자주 보였지만, 끝으로 갈수록 '안도감'이 높아졌어요.")
    - **심층 리포트** 발행 시 일기 데이터와 채팅 데이터를 통합하여 더 정확한 결과를 도출합니다.

---

## 3. 기술적 접근 (Technical Architecture)

### 3.1. 비동기 분석 파이프라인 (Async Pipeline)

대화의 **즉시성(Latency)**을 해치지 않기 위해 **응답 생성**과 **심리 분석**을 분리합니다.

- **Step 1 (Sync): 즉시 응답**
  - `App` -> `Server`: 메시지 전송
  - `Server` -> `Gemma 2 (AI)`: "공감하는 답변 생성해줘"
  - `Server` -> `App`: 답변 반환 (사용자는 바로 답변을 봄)

- **Step 2 (Async): 심층 분석 (백그라운드 스레드)**
  - `Server` (응답 후) -> `Analysis Thread`: 방금 대화 내용 분석 요청
  - `AI (Analyzer)`: "이 발화에서 '감정 키워드(60종)', '스트레스 레벨(0-10)', '인지적 오류'를 추출해줘."
  - `DB`: 분석 결과 저장 (`ChatLog` 컬렉션)

### 3.2. AI 모델 프롬프트 엔지니어링

단순 대화가 아닌 **데이터 추출(Extraction)**을 위한 프롬프트를 설계합니다.

```python
# 분석 프롬프트 예시
prompt = """
사용자의 발화: "{user_text}"

위 발화를 심리학적으로 분석하여 JSON 형식으로 출력하시오.
1. Emotion: 60가지 감정 중 가장 지배적인 감정 1~3개
2. Sentiment: 긍정/부정/중립 점수 (-1.0 ~ 1.0)
3. Risk: 자살, 자해, 폭력성 위험 징후 여부 (Boolean)
4. Needs: 내담자가 현재 가장 원하는 것 (예: 위로, 해결책, 경청)
"""
```

---

## 4. 데이터베이스 설계 (MongoDB)

기존 `Chat` 로그를 저장하지 않던 방식에서, **분석 데이터를 포함한 영구 저장** 방식으로 변경합니다.

### `chat_logs` Collection

```json
{
  "_id": ObjectId("..."),
  "user_id": ObjectId("..."),
  "session_id": "uuid-session-123",  // 대화 세션 구분
  "user_message": "요즘 너무 잠이 안 와서 미치겠어.",
  "ai_response": "잠을 못 주무셔서 정말 괴로우시겠어요. 걱정되는 일이 있으신가요?",
  "analysis": {
    "primary_emotion": "Frustration (좌절)",
    "secondary_emotion": "Anxiety (불안)",
    "stress_level": 8, // 0-10
    "risk_flag": false,
    "detected_keywords": ["불면", "괴로움"]
  },
  "created_at": ISODate("2026-01-25T...")
}
```

---

## 5. 단계별 구현 계획 (Roadmap)

### Phase 1: 백엔드 분석 엔진 구축 (이번 요청 범위)

1.  **AI 분석 함수 구현 (`standalone_ai.py`)**
    - JSON 포맷으로 감정 데이터를 추출하는 `analyze_sentiment_chat()` 함수 추가.
2.  **비동기 스레드 연동 (`app.py`)**
    - `/api/chat/reaction` 호출 시, 응답 후 별도 스레드에서 분석 함수 실행.
3.  **DB 저장 로직 구현**
    - MongoDB에 `chat_logs` 컬렉션 생성 및 데이터 적재 로직 구현.

### Phase 2: 데이터 활용 및 시각화 (추후)

1.  **iOS 앱 리포트 탭 연동**
    - "최근 대화 감정 흐름" 그래프 표시.
2.  **주간/월간 리포트 통합**
    - 일기 데이터 + 채팅 데이터를 합쳐서 더 정교한 "마음 날씨" 제공.

---

## 6. 기대 효과

- **데이터 자산화**: 휘발되던 채팅 데이터를 소중한 **심리 분석 자산**으로 전환.
- **개인화 강화**: 분석된 데이터를 바탕으로 다음 대화에서 "지난번에 잠 못 주무신 건 좀 어떠세요?"라고 **먼저 묻는 AI** 구현 가능.
- **위기 대응**: 위험 징후 포착 시 긴급 도움말 제공 가능.
