# 🏗️ 비동기 AI 처리 아키텍처 계획서 (Celery + Redis)

## 1. 개요

현재 Mood Diary 애플리케이션은 사용자가 일기를 저장할 때 AI 분석(Polyglot-Ko 1.3B)이 완료될 때까지 기다려야 하는 **동기식(Synchronous)** 구조입니다.
이로 인해 다음과 같은 문제가 발생하고 있습니다.

- **504 Gateway Timeout**: AI 분석 시간이 길어지면 Nginx가 연결을 끊어버림.
- **서버 먹통**: AI 모델 로딩/추론 시 CPU를 독점하여 로그인 등 단순 요청까지 지연됨.

이를 해결하기 위해 **Celery(비동기 작업 큐)**와 **Redis(메시지 브로커)**를 도입하여, 무거운 AI 작업을 백그라운드로 분리합니다.

---

## 2. 변경 전/후 비교

### 🔴 변경 전 (현재)

- **User 요청** -> **Flask 서버** (일기 저장 + **AI 분석 대기**) -> **응답**
- **문제점**: 사용자는 AI 분석(5~30초)이 끝날 때까지 멍하니 기다려야 함.

### 🟢 변경 후 (목표)

- **User 요청** -> **Flask 서버** (일기 저장 + **작업 큐에 등록**) -> **즉시 응답 ("저장 완료!")**
- **Celery 워커** (백그라운드) -> **작업 큐 확인** -> **AI 분석 수행** -> **DB 업데이트**
- **장점**:
  1. 일기 저장 버튼 누르자마자 0.1초 만에 완료 메시지 뜸.
  2. Flask 서버는 가벼워져서 로그인/조회 요청을 빠르게 처리함.
  3. AI가 30초가 걸리든 1분이 걸리든 사용자 경험에는 영향 없음.

---

## 3. 기술 스택 및 구조

|       컴포넌트       | 역할                   | 비고                                      |
| :------------------: | :--------------------- | :---------------------------------------- |
| **Flask (Gunicorn)** | 웹 서버 (API 처리)     | AI 모델 로딩 안 함 (가벼움)               |
|      **Redis**       | 메시지 브로커 (우체통) | Flask가 남긴 쪽지("일기 분석해줘")를 보관 |
|  **Celery Worker**   | AI 작업자 (일꾼)       | 무거운 AI 모델 로딩. 쪽지 가져와서 처리   |
| **MySQL (MariaDB)**  | 데이터베이스           | 일기 데이터 및 분석 결과 저장             |

---

## 4. 파일 변경 및 구현 계획

### 📂 Backend

1.  **`requirements.txt`**: `celery`, `redis` 라이브러리 추가.
2.  **`celery_app.py` (신규)**: Celery 인스턴스 설정 파일 생성.
3.  **`tasks.py` (신규)**: AI 분석 로직(`EmotionAnalysis`)을 여기로 이동하고, 비동기 함수(`@celery.task`)로 정의.
    - AI 모델(`Polyglot`) 로딩은 이 프로세스에서만 수행됨.
4.  **`app.py` (수정)**:
    - `import ai_brain` 제거 (Flask는 AI를 몰라도 됨).
    - 일기 저장 API에서 `ai_analyzer.predict()` 대신 `process_diary_ai.delay(diary_id)` 호출.
5.  **`models.py` (수정)**: 순환 참조 방지를 위한 구조 점검.

### 🖥️ Server (OCI)

1.  **Redis 설치**: `sudo apt install redis-server`
2.  **서비스 분리 (systemd)**:
    - `mood_backend.service`: Gunicorn 웹 서버 (가벼움, 포트 5001)
    - `mood_celery.service`: Celery 워커 (무거움, AI 전담)

---

## 5. 배포 시나리오

1.  **로컬 개발**:
    - Mac에서 코드 수정 및 테스트.
    - `redis`는 로컬(Docker 또는 brew)에서 테스트하거나 생략하고 배포.
2.  **서버 배포**:
    - `git pull`
    - `pip install -r requirements.txt` (celery, redis)
    - `sudo apt install redis-server`
    - 서비스 파일 2개 생성 및 실행.
3.  **최종 확인**:
    - 웹에서 일기 작성 -> "저장 완료" 팝업 즉시 확인.
    - 몇 초 뒤 새로고침 -> AI 분석 결과가 업데이트되어 있는지 확인.

---

## 6. 예상 소요 시간

- **총 30~60분**
  - 코드 작업: 20분
  - 서버 설정 및 설치: 15분
  - 테스트 및 안정화: 15분
